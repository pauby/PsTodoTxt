# Appveyor Options http://www.appveyor.com/docs/appveyor-yml
# Appveyor Environment Variables https://www.appveyor.com/docs/environment-variables/
version: 1.1.0.{build}

os: WMF 5
max_jobs: 1

branches:
  only:
  - master

#skip_non_tags: true

build: false # disable MSBuild

environment:
  PSGALLERY_API_KEY:
    secure: TO/Slq79myoBRfUTivNSeScz0nRWFlFp0JMiImdmHVZLsSa349qCi98nm29e6uGC

  GITHUB_API_KEY:
    secure: jmTiAdpCVvSrW0a0kDpC+ucDk4WSnSiNJhpVbsE+FKx1ZwzB189RUmFvnbgkBGBw

  GITHUB_USERNAME:
    secure: WbMc18DNWPRELk0QTnab0Q==

  appveyor_rdp_password:
    secure: CC+F6/yXM5KgZMVnjjHyBIaw8aK8oOCYipXqGfQUHEE=

  TWITTER_API_KEY:
    secure: meJYucOgoV/VjoB5wpB/QVQHRVqj3XVc9cn+b+nOi0Q=

  TWITTER_API_KEY_SECRET:
    secure: 6+Yae/vAjeaOo1AuOliMD5B+7z6OMPDrlSeGyNV4wm4VDTBgYPSr9QqdrhuEtdUDTopVEA+93r5t3EPWw4Ol8A==

  TWITTER_API_ACCESS_TOKEN:
    secure: F2Ynh4ajTEv/bp8L8GkfaS4WyMF+7VBAA8cPVF50OO1wT2sHlCaIzDZBtuE7R/y5sLpDeDhdXm3DLkgd2hLpug==

  TWITTER_API_ACCESS_TOKEN_SECRET:
    secure: X5QyyPoP+VKwmn0FnOowwGgQ+rp7f2Sj2VTQMmQaNrelKJzikM8GnNnWvHAobYZ8

init:
  - ps: |
      git config --global core.autocrlf input
#      iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

install:
  - git --version
  - choco --version

  - ps: |
      git config --global credential.helper store
      Add-Content "$env:USERPROFILE\.git-credentials" "https://$($env:GITHUB_API_KEY):x-oauth-basic@github.com`n"
      .\Initialize-Build.ps1

build_script:
  - ps: |
      if ($env:APPVEYOR_REPO_TAG -eq 'true' -and $env:APPVEYOR_REPO_TAG_NAME -match "(?<version>[\d\.]+)") {
        Update-Manifest -Path .\source\PSTodoTxt.psd1 -PropertyName moduleversion -Value $matches.version
      }

      .\build.ps1 -Task build

test_script:
  - ps: |
        if ($env:APPVEYOR_REPO_TAG -eq 'true' -and $env:APPVEYOR_REPO_TAG_NAME -match "(?<version>[\d\.]+)") {
          Update-Manifest -Path .\source\PSTodoTxt.psd1 -PropertyName moduleversion -Value $matches.version
        }

        .\build.ps1 -Task test

deploy_script:
  - ps: |
      if ($env:APPVEYOR_REPO_TAG -eq 'true') {
        .\build.ps1 -Task publish, announce
      }
      else {
        Write-Host 'Commit not a tag - not deploying.'
      }

test:

deploy:

on_finish:
#  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))